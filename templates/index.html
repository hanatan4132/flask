<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>加密貨幣資費監控 (Coinglass 樣式)</title>
    <!-- 引入 Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .rate-positive { color: #198754; font-weight: bold; } /* 綠色 */
        .rate-negative { color: #dc3545; font-weight: bold; } /* 紅色 */
        .rate-cell { white-space: nowrap; font-family: monospace; font-size: 1.1em; } 
        .time-cell { font-size: 0.8rem; color: #6c757d; }
        
        /* 表頭樣式優化 */
        .sortable-header {
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s;
        }
        .sortable-header:hover {
            background-color: #444 !important; /* 滑鼠懸停變色 */
        }
        .sort-icon {
            font-size: 0.8em;
            margin-left: 5px;
            color: #aaa;
        }
        .sort-active {
            color: #fff; /* 當前排序的箭頭變亮 */
        }

        .sticky-top-2 {
            position: sticky;
            top: 50px;
            background-color: #fff;
            z-index: 10;
            box-shadow: 0 2px 2px -1px rgba(0,0,0,0.1);
        }
        .loading { text-align: center; margin: 20px; font-size: 1.2rem; color: #666; }
    </style>
</head>
<body class="bg-light">

<div class="container-fluid py-4" style="max-width: 1400px;">
    <h2 class="text-center mb-4">Binance / Bybit / Bitget USDT 合約資費表</h2>
    
    <div class="d-flex justify-content-between align-items-center mb-3 px-2">
        <span>上次更新: <span id="update-time" class="fw-bold">--:--:--</span></span>
        <div>
            <span class="text-muted small me-2">點擊交易所名稱可排序</span>
            <button class="btn btn-primary btn-sm" onclick="fetchData()">立即刷新</button>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-body p-0">
            <div id="loading-spinner" class="loading">
                <div class="spinner-border text-primary" role="status"></div>
                <p>正在從交易所獲取數據，請稍候...</p>
            </div>
            
            <div class="table-responsive" style="max-height: 85vh; overflow-y: auto;">
                <table class="table table-striped table-hover mb-0" id="rates-table" style="display: none;">
                    
                    <thead class="sticky-top">
                        <!-- 第一層表頭：點擊這裡可以排序 -->
                        <tr class="table-dark">
                            <th rowspan="2" class="align-middle">幣種</th>
                            {% for ex_id in exchanges %}
                            <!-- 加上 onclick 事件，傳入交易所 ID -->
                            <th colspan="2" class="text-center sortable-header" onclick="handleSort('{{ ex_id }}')">
                                {{ ex_id.capitalize() }}
                                <span id="icon-{{ ex_id }}" class="sort-icon">▼</span>
                            </th>
                            {% endfor %}
                        </tr>
                        <!-- 第二層表頭 -->
                        <tr class="table-secondary sticky-top-2">
                            {% for ex_id in exchanges %}
                            <th class="text-center">費率</th>
                            <th class="text-center time-cell">下次結算</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        <!-- 資料將由 JS 插入 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- 引入 jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    const EXCHANGES = ['binance', 'bybit', 'bitget']; 
    let globalData = []; // 儲存目前的數據，供排序使用
    
    // 排序狀態
    let currentSortExchange = 'binance'; // 預設依幣安排序
    let sortDirection = 1; // 1: 由小到大 (asc), -1: 由大到小 (desc)

    // 點擊表頭觸發的排序函式
    function handleSort(exchangeId) {
        if (currentSortExchange === exchangeId) {
            // 如果點擊同一個交易所，切換順序
            sortDirection *= -1;
        } else {
            // 如果點擊不同交易所，重置為由小到大
            currentSortExchange = exchangeId;
            sortDirection = 1;
        }
        
        updateSortIcons();
        sortAndRender(); // 重新排序並渲染
    }

    // 更新箭頭圖示
    function updateSortIcons() {
        EXCHANGES.forEach(ex => {
            const icon = $(`#icon-${ex}`);
            icon.removeClass('sort-active');
            icon.text('▼'); // 預設顯示
            
            if (ex === currentSortExchange) {
                icon.addClass('sort-active');
                icon.text(sortDirection === 1 ? '▲' : '▼'); // 1=小到大(上箭頭), -1=大到小(下箭頭)
            }
        });
    }

    // 核心邏輯：排序並產生 HTML
    function sortAndRender() {
        const key = `${currentSortExchange}_rate`;

        // 排序數據
        globalData.sort((a, b) => {
            let valA = a[key];
            let valB = b[key];

            // 處理 null 值 (沒有數據的排在最後面)
            if (valA === null) return 1;
            if (valB === null) return -1;

            return (valA - valB) * sortDirection;
        });

        // 生成 HTML
        let rows = '';
        globalData.forEach(item => {
            let exchangeCells = EXCHANGES.map(ex => {
                const rateKey = `${ex}_rate`;
                const timeKey = `${ex}_time`;
                const rate = item[rateKey];
                const time = item[timeKey] || '-';

                let rateDisplay = '-';
                let colorClass = '';

                if (rate !== null && rate !== undefined) {
                    rateDisplay = (rate * 100).toFixed(4) + '%';
                    colorClass = rate >= 0 ? 'rate-positive' : 'rate-negative';
                }

                return `
                    <td class="rate-cell text-center ${colorClass}">${rateDisplay}</td>
                    <td class="time-cell text-center">${time}</td>
                `;
            }).join('');

            rows += `
                <tr>
                    <td class="fw-bold">${item.symbol}</td>
                    ${exchangeCells}
                </tr>
            `;
        });

        $('#table-body').html(rows);
    }

    // 從後端獲取數據
    function fetchData() {
        $('#loading-spinner').show();
        if ($('#table-body tr').length > 0) {
            $('#rates-table').css('opacity', '0.5');
        } else {
            $('#rates-table').hide();
        }

        $.ajax({
            url: '/api/rates',
            method: 'GET',
            success: function(response) {
                globalData = response.data; // 更新全局數據
                $('#update-time').text(response.updated_at);
                
                updateSortIcons(); // 初始化圖示
                sortAndRender();   // 排序並顯示
                
                $('#loading-spinner').hide();
                $('#rates-table').show().css('opacity', '1');
            },
            error: function() {
                alert('獲取數據失敗，請稍後再試。');
                $('#loading-spinner').hide();
                $('#rates-table').css('opacity', '1');
            }
        });
    }

    $(document).ready(function() {
        fetchData();
        setInterval(fetchData, 60000); 
    });
</script>

</body>
</html>
