<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>加密貨幣資費監控 (UTC+8)</title>
    <!-- 引入 Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        .rate-positive { color: #198754; font-weight: bold; }
        .rate-negative { color: #dc3545; font-weight: bold; }
        .rate-cell { white-space: nowrap; font-family: monospace; font-size: 1.1em; } 
        .time-cell { font-size: 0.8rem; color: #6c757d; white-space: nowrap; }
        
        /* --- 修正表格擋住問題的 CSS --- */
        
        /* 1. 第一層表頭 (交易所) */
        thead tr.header-row-1 th {
            position: sticky;
            top: 0;
            background-color: #212529; /* 深色背景 */
            color: white;
            z-index: 100; /* 最高層級 */
            height: 50px; /* 固定高度 */
            vertical-align: middle;
            box-shadow: 0 1px 0 #444; /* 邊框線 */
        }

        /* 2. 第二層表頭 (費率/時間) */
        thead tr.header-row-2 th {
            position: sticky;
            top: 50px; /* 這裡的值必須等於第一層的高度 */
            background-color: #e9ecef; /* 淺灰背景，不透明 */
            z-index: 90; /* 比第一層低，但比內容高 */
            box-shadow: 0 2px 2px -1px rgba(0,0,0,0.1);
            font-size: 0.9rem;
        }

        /* 3. 第一列 (幣種名稱) */
        /* 讓幣種名稱在橫向滾動時也固定在左側 (Optional, 手機版好用) */
        tbody td:first-child, thead th:first-child {
            position: sticky;
            left: 0;
            background-color: inherit; /* 跟隨原本的背景色 */
            z-index: 50; /* 比內容高 */
        }
        /* 修正表頭左上角交界處 */
        thead tr.header-row-1 th:first-child {
            z-index: 110; 
        }
        thead tr.header-row-2 th:first-child {
            z-index: 110; 
        }

        .sortable-header { cursor: pointer; user-select: none; }
        .sortable-header:hover { background-color: #444 !important; }
        .sort-icon { font-size: 0.8em; margin-left: 5px; color: #aaa; }
        .sort-active { color: #fff; }
        .loading { text-align: center; margin: 20px; font-size: 1.2rem; color: #666; }
    </style>
</head>
<body class="bg-light">

<div class="container-fluid py-4" style="max-width: 1400px;">
    <h3 class="text-center mb-4">全交易所 USDT 合約資費監控</h3>
    
    <div class="d-flex justify-content-between align-items-center mb-3 px-2">
        <span class="small text-muted">時區: UTC+8 (台灣時間) | 上次更新: <span id="update-time" class="fw-bold text-dark">--:--:--</span></span>
        <div>
            <span class="text-muted small me-2 d-none d-md-inline">點擊交易所標題可排序</span>
            <button class="btn btn-primary btn-sm" onclick="fetchData()">刷新</button>
        </div>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-body p-0">
            <div id="loading-spinner" class="loading">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2">正在同步數據...</p>
            </div>
            
            <div class="table-responsive" style="max-height: 80vh; overflow-y: auto;">
                <table class="table table-striped table-hover mb-0" id="rates-table" style="display: none;">
                    <thead>
                        <!-- 第一層表頭 -->
                        <tr class="header-row-1">
                            <th rowspan="2" class="text-center" style="min-width: 100px;">幣種</th>
                            {% for ex_id in exchanges %}
                            <th colspan="2" class="text-center sortable-header" onclick="handleSort('{{ ex_id }}')">
                                {{ ex_id.capitalize() }}
                                <span id="icon-{{ ex_id }}" class="sort-icon">▼</span>
                            </th>
                            {% endfor %}
                        </tr>
                        <!-- 第二層表頭 -->
                        <tr class="header-row-2">
                            {% for ex_id in exchanges %}
                            <th class="text-center">費率</th>
                            <th class="text-center">結算</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        <!-- JS 填入 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    const EXCHANGES = ['binance', 'bybit', 'bitget']; 
    let globalData = [];
    let currentSortExchange = 'binance'; 
    let sortDirection = 1; 

    function handleSort(exchangeId) {
        if (currentSortExchange === exchangeId) {
            sortDirection *= -1;
        } else {
            currentSortExchange = exchangeId;
            sortDirection = 1;
        }
        updateSortIcons();
        sortAndRender();
    }

    function updateSortIcons() {
        EXCHANGES.forEach(ex => {
            const icon = $(`#icon-${ex}`);
            icon.removeClass('sort-active');
            icon.text('▼'); 
            if (ex === currentSortExchange) {
                icon.addClass('sort-active');
                icon.text(sortDirection === 1 ? '▲' : '▼');
            }
        });
    }

    function sortAndRender() {
        const key = `${currentSortExchange}_rate`;
        globalData.sort((a, b) => {
            let valA = a[key];
            let valB = b[key];
            if (valA === null) return 1;
            if (valB === null) return -1;
            return (valA - valB) * sortDirection;
        });

        let rows = '';
        globalData.forEach(item => {
            let exchangeCells = EXCHANGES.map(ex => {
                const rateKey = `${ex}_rate`;
                const timeKey = `${ex}_time`;
                const rate = item[rateKey];
                const time = item[timeKey] || '-';

                let rateDisplay = '-';
                let colorClass = '';

                if (rate !== null && rate !== undefined) {
                    rateDisplay = (rate * 100).toFixed(4) + '%';
                    colorClass = rate >= 0 ? 'rate-positive' : 'rate-negative';
                }

                return `
                    <td class="rate-cell text-center ${colorClass}">${rateDisplay}</td>
                    <td class="time-cell text-center">${time}</td>
                `;
            }).join('');

            rows += `<tr><td class="fw-bold text-center">${item.symbol}</td>${exchangeCells}</tr>`;
        });
        $('#table-body').html(rows);
    }

    function fetchData() {
        $('#loading-spinner').show();
        if ($('#table-body tr').length > 0) {
            $('#rates-table').css('opacity', '0.5');
        } else {
            $('#rates-table').hide();
        }

        $.ajax({
            url: '/api/rates',
            method: 'GET',
            success: function(response) {
                globalData = response.data;
                $('#update-time').text(response.updated_at);
                updateSortIcons();
                sortAndRender();
                $('#loading-spinner').hide();
                $('#rates-table').show().css('opacity', '1');
            },
            error: function() {
                // alert('獲取數據失敗，請稍後再試。'); 
                // 為了體驗，失敗時也可以不跳 alert，只在 console 報錯
                console.error("Fetch error");
                $('#loading-spinner').hide();
                $('#rates-table').css('opacity', '1');
            }
        });
    }

    $(document).ready(function() {
        fetchData();
        setInterval(fetchData, 60000); 
    });
</script>

</body>
</html>
